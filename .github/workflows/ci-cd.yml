name: CI/CD Pipeline

on:
  push:
    branches: [main, test]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: docker.io
  IMAGE_NAME: mobilizon-app

jobs:
  # TODO: Backend tests disabled temporarily - need to optimize for better performance
  # Re-enable after async test optimizations are properly tuned
  # test-backend:
  #   runs-on: ubuntu-latest

  #   services:
  #     postgres:
  #       image: postgis/postgis:15-3.4
  #       env:
  #         POSTGRES_USER: mobilizon_test
  #         POSTGRES_PASSWORD: mobilizon
  #         POSTGRES_DB: mobilizon_test
  #       ports:
  #         - 5432:5432
  #       options: >-
  #         --health-cmd pg_isready
  #         --health-interval 10s
  #         --health-timeout 5s
  #         --health-retries 5

  #   env:
  #     MIX_ENV: test
  #     MOBILIZON_DATABASE_HOST: localhost
  #     MOBILIZON_DATABASE_USERNAME: mobilizon_test
  #     MOBILIZON_DATABASE_PASSWORD: mobilizon
  #     MOBILIZON_DATABASE_DBNAME: mobilizon_test

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Set up Elixir
  #       uses: erlef/setup-beam@v1
  #       with:
  #         elixir-version: '1.15'
  #         otp-version: '26'

  #     - name: Cache dependencies
  #       uses: actions/cache@v3
  #       with:
  #         path: |
  #           deps
  #           _build
  #         key: ${{ runner.os }}-mix-${{ hashFiles('**/mix.lock') }}
  #         restore-keys: ${{ runner.os }}-mix-

  #     - name: Install dependencies
  #       run: mix deps.get

  #     - name: Prepare test database
  #       run: mix prepare_test

  #     - name: Run tests
  #       run: mix test

  #     - name: Run Credo
  #       run: mix credo --strict

  #     - name: Run Sobelow security scan
  #       run: mix sobelow --config

  test-frontend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:ci

      - name: Run linting
        run: npm run lint

  build:
    needs: [test-frontend]  # test-backend temporarily disabled
    runs-on: ubuntu-latest
    # Run on PRs and main/test branches
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      tag: ${{ steps.env.outputs.tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Determine deployment environment
        id: env
        run: |
          if [[ $GITHUB_REF == 'refs/heads/main' ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "tag=latest" >> $GITHUB_OUTPUT
          elif [[ $GITHUB_REF == 'refs/heads/test' ]]; then
            echo "environment=test" >> $GITHUB_OUTPUT
            echo "tag=test" >> $GITHUB_OUTPUT
          else
            # For PRs and other branches, use short SHA
            echo "environment=pr" >> $GITHUB_OUTPUT
            echo "tag=pr-${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
          fi

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/production/Dockerfile
          # Only push to registry on main/test branches, not PRs
          push: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/test' }}
          tags: |
            ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.env.outputs.tag }}
            ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  test-e2e:
    needs: build
    runs-on: ubuntu-latest
    # Run on PRs and main/test branches

    services:
      postgres:
        image: postgis/postgis:15-3.4
        env:
          POSTGRES_USER: mobilizon
          POSTGRES_PASSWORD: mobilizon
          POSTGRES_DB: mobilizon_prod
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Node.js dependencies
        run: npm ci

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Determine image tag
        id: tag
        run: |
          if [[ $GITHUB_REF == 'refs/heads/main' ]]; then
            echo "tag=latest" >> $GITHUB_OUTPUT
          elif [[ $GITHUB_REF == 'refs/heads/test' ]]; then
            echo "tag=test" >> $GITHUB_OUTPUT
          else
            # For PRs, use short SHA (must match build job)
            echo "tag=pr-${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
          fi

      - name: Pull Docker image (main/test branches)
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/test'
        run: docker pull ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}
      
      - name: Build Docker image locally (PRs only)
        if: github.event_name == 'pull_request'
        run: |
          docker build -f docker/production/Dockerfile -t ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }} .

      - name: Create docker-compose configuration for E2E tests
        run: |
          cat > docker-compose.e2e.yml << EOF
          version: "3.8"
          services:
            mobilizon:
              image: ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}
              ports:
                - "4000:4000"
              environment:
                MOBILIZON_INSTANCE_NAME: "Test Instance"
                MOBILIZON_INSTANCE_HOST: "localhost"
                MOBILIZON_DATABASE_HOST: host.docker.internal
                MOBILIZON_DATABASE_USERNAME: mobilizon
                MOBILIZON_DATABASE_PASSWORD: mobilizon
                MOBILIZON_DATABASE_DBNAME: mobilizon_prod
                MOBILIZON_DATABASE_PORT: 5432
                MOBILIZON_INSTANCE_REGISTRATIONS_OPEN: "true"
              extra_hosts:
                - "host.docker.internal:host-gateway"
          EOF

      - name: Start application
        run: |
          docker-compose -f docker-compose.e2e.yml up -d
          echo "Waiting for application to be ready..."
          npx wait-on http://localhost:4000 -t 60000

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run E2E tests
        run: npx playwright test

      - name: Upload test artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

      - name: Stop application
        if: always()
        run: docker-compose -f docker-compose.e2e.yml down

  deploy-dev:
    needs: [build, test-e2e]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/test' || github.ref == 'refs/heads/main'

    steps:
      - name: Deploy to development server
        run: |
          # Set up SSH key
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Add SSH key to agent
          eval $(ssh-agent -s)
          ssh-add ~/.ssh/id_rsa

          # Add server to known hosts to avoid host key verification
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST_DEV }} >> ~/.ssh/known_hosts

          # Connect and run deployment commands
          ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST_DEV }} -A << 'EOF'
            cd /root/mobilizon
            git pull
            cd /root/mobilizon/docker/production
            docker compose down
            docker compose up -d
          EOF

  deploy-prod:
    needs: [build, test-e2e]
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Deploy to production server
        run: |
          # Set up SSH key
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Add SSH key to agent
          eval $(ssh-agent -s)
          ssh-add ~/.ssh/id_rsa

          # Add server to known hosts to avoid host key verification
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

          # Connect and run deployment commands
          ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} -A << 'EOF'
            cd /root/mobilizon
            git pull
            cd /root/mobilizon/docker/production
            docker compose down
            docker compose up -d
          EOF
