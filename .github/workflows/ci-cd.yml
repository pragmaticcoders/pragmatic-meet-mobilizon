name: CI/CD Pipeline

on:
  push:
    branches: [main, test]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: docker.io
  IMAGE_NAME: mobilizon-app

jobs:
  test-backend:
    runs-on: ubuntu-latest
    # Skip tests on manual trigger for fast deployment
    if: github.event_name != 'workflow_dispatch'

    services:
      postgres:
        image: postgis/postgis:15-3.4
        env:
          POSTGRES_USER: mobilizon_test
          POSTGRES_PASSWORD: mobilizon
          POSTGRES_DB: mobilizon_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      MIX_ENV: test
      MOBILIZON_DATABASE_HOST: localhost
      MOBILIZON_DATABASE_USERNAME: mobilizon_test
      MOBILIZON_DATABASE_PASSWORD: mobilizon
      MOBILIZON_DATABASE_DBNAME: mobilizon_test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: '1.15'
          otp-version: '26'

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            deps
            _build
          key: ${{ runner.os }}-mix-${{ hashFiles('**/mix.lock') }}
          restore-keys: ${{ runner.os }}-mix-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick
          which identify
          identify -version

      - name: Install dependencies
        run: mix deps.get

      - name: Prepare test database
        run: mix prepare_test

      - name: Run tests
        run: mix test

      - name: Run Credo (informational)
        run: mix credo
        continue-on-error: true

      - name: Run Sobelow security scan (informational)
        run: mix sobelow --config
        continue-on-error: true

  test-frontend:
    runs-on: ubuntu-latest
    # Skip tests on manual trigger for fast deployment
    if: github.event_name != 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:ci

      - name: Run linting
        run: npm run lint

  # Build for PRs (without push) - used for E2E testing
  build-pr:
    needs: [test-frontend, test-backend]
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    outputs:
      image_tag: ${{ steps.build.outputs.imageid }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (local, no push)
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/production/Dockerfile
          push: false
          load: true
          tags: mobilizon-e2e:ci-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Save Docker image for E2E tests
        run: |
          docker save mobilizon-e2e:ci-${{ github.sha }} -o /tmp/mobilizon-e2e.tar

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: /tmp/mobilizon-e2e.tar
          retention-days: 1

  # Build for main/test branches (with push) - for deployment and E2E testing
  build:
    needs: [test-frontend, test-backend]
    runs-on: ubuntu-latest
    # Run on push to main/test OR on workflow_dispatch from main (skip tests, build directly)
    # Use always() to allow running when tests are skipped on workflow_dispatch
    if: |
      always() &&
      ((github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/test')) ||
       (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main')) &&
      (needs.test-frontend.result == 'success' || needs.test-frontend.result == 'skipped') &&
      (needs.test-backend.result == 'success' || needs.test-backend.result == 'skipped')
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      tag: ${{ steps.env.outputs.tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Determine deployment environment
        id: env
        run: |
          if [[ $GITHUB_REF == 'refs/heads/main' ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "tag=latest" >> $GITHUB_OUTPUT
          elif [[ $GITHUB_REF == 'refs/heads/test' ]]; then
            echo "environment=test" >> $GITHUB_OUTPUT
            echo "tag=test" >> $GITHUB_OUTPUT
          fi

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/production/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.env.outputs.tag }}
            ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # E2E tests for PRs - uses locally built Docker image from artifact
  test-e2e-pr:
    needs: build-pr
    runs-on: ubuntu-22.04
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Node.js dependencies
        run: npm ci

      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load Docker image
        run: docker load -i /tmp/mobilizon-e2e.tar

      - name: Start services with docker-compose
        env:
          MOBILIZON_E2E_IMAGE: mobilizon-e2e:ci-${{ github.sha }}
        run: |
          docker compose -f docker/e2e/docker-compose.yml up -d
          echo "Waiting for application to be ready..."
          npx wait-on http://localhost:4000 -t 120000 || (docker compose -f docker/e2e/docker-compose.yml logs && exit 1)

      - name: Install Playwright system dependencies
        run: npx playwright install-deps chromium

      - name: Install Playwright Chromium browser
        run: npx playwright install chromium

      - name: Run E2E tests
        run: npx playwright test --project chromium

      - name: Upload test artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-pr
          path: |
            playwright-report/
            test-results/
          retention-days: 7

      - name: Stop services
        if: always()
        run: docker compose -f docker/e2e/docker-compose.yml down -v

  # E2E tests for main branch - uses pushed Docker image from registry
  test-e2e-main:
    needs: build
    runs-on: ubuntu-22.04
    # Run on push to main/test, skip on workflow_dispatch (fast deployment)
    if: |
      github.event_name == 'push' && 
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/test')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Node.js dependencies
        run: npm ci

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Determine image tag
        id: tag
        run: |
          if [[ $GITHUB_REF == 'refs/heads/main' ]]; then
            echo "tag=latest" >> $GITHUB_OUTPUT
          elif [[ $GITHUB_REF == 'refs/heads/test' ]]; then
            echo "tag=test" >> $GITHUB_OUTPUT
          fi

      - name: Pull Docker image from registry
        run: docker pull ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}

      - name: Start services with docker-compose
        env:
          MOBILIZON_E2E_IMAGE: ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}
        run: |
          docker compose -f docker/e2e/docker-compose.yml up -d
          echo "Waiting for application to be ready..."
          npx wait-on http://localhost:4000 -t 120000 || (docker compose -f docker/e2e/docker-compose.yml logs && exit 1)

      - name: Install Playwright system dependencies
        run: npx playwright install-deps chromium

      - name: Install Playwright Chromium browser
        run: npx playwright install chromium

      - name: Run E2E tests
        run: npx playwright test --project chromium

      - name: Upload test artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-main
          path: |
            playwright-report/
            test-results/
          retention-days: 7

      - name: Stop services
        if: always()
        run: docker compose -f docker/e2e/docker-compose.yml down -v

  deploy-dev:
    # Deploy to dev ONLY on push to main/test (after E2E tests pass)
    needs: [build, test-e2e-main]
    runs-on: ubuntu-latest
    if: |
      always() &&
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/test' || github.ref == 'refs/heads/main') &&
      (needs.build.result == 'success') &&
      (needs.test-e2e-main.result == 'success' || needs.test-e2e-main.result == 'skipped')

    steps:
      - name: Deploy to development server
        run: |
          # Set up SSH key
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Add SSH key to agent
          eval $(ssh-agent -s)
          ssh-add ~/.ssh/id_rsa

          # Add server to known hosts to avoid host key verification
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST_DEV }} >> ~/.ssh/known_hosts

          # Connect and run deployment commands
          ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST_DEV }} -A << 'EOF'
            cd /root/mobilizon
            git pull
            cd /root/mobilizon/docker/production
            docker compose down
            docker compose up -d
          EOF

  deploy-prod:
    needs: [build]
    runs-on: ubuntu-latest
    # Only deploy to prod on manual trigger (workflow_dispatch) from main branch
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.ref == 'refs/heads/main' &&
      needs.build.result == 'success'

    steps:
      - name: Deploy to production server
        run: |
          # Set up SSH key
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Add SSH key to agent
          eval $(ssh-agent -s)
          ssh-add ~/.ssh/id_rsa

          # Add server to known hosts to avoid host key verification
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

          # Connect and run deployment commands
          ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} -A << 'EOF'
            cd /root/mobilizon
            git pull
            cd /root/mobilizon/docker/production
            docker compose down
            docker compose up -d
          EOF
