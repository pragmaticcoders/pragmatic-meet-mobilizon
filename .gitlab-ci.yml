image: tcitworld/mobilizon-ci

stages:
  - install
  - check
  - build-js
  - test
  - build
  - upload
  - deploy

variables:
  MIX_ENV: "test"
  # DB Variables for Postgres / Postgis
  POSTGRES_DB: mobilizon_test
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: postgres
  POSTGRES_HOST: postgres
  # DB Variables for Mobilizon
  MOBILIZON_DATABASE_USERNAME: $POSTGRES_USER
  MOBILIZON_DATABASE_PASSWORD: $POSTGRES_PASSWORD
  MOBILIZON_DATABASE_DBNAME: $POSTGRES_DB
  MOBILIZON_DATABASE_HOST: $POSTGRES_HOST
  GEOLITE_CITIES_PATH: "/usr/share/GeoIP/GeoLite2-City.mmdb"
  MOBILIZON_INSTANCE_REGISTRATIONS_OPEN: "true"
  # Release elements
  PACKAGE_REGISTRY_URL: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${CI_PROJECT_NAME}"
  ARCH: "amd64"
  EXPORT_FORMATS: "csv,ods,pdf"
  APP_VERSION: "${CI_COMMIT_REF_NAME}"
  APP_ASSET: "${CI_PROJECT_NAME}_${CI_COMMIT_REF_NAME}_${ARCH}.tar.gz"

cache:
  key: "${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"
  paths:
    - deps/
    - _build/
    - node_modules
    - .npm

# Installed dependencies are cached across the pipeline
# So there is no need to reinstall them all the time
# It saves minutes during a pipeline build time
install:
  stage: install
  rules:
    - if: '$CI_PIPELINE_SOURCE == "trigger" && $CI_COMMIT_BRANCH == "main"'
      when: never
    - when: on_success
  script:
    - npm ci
    - mix deps.get
    - mix compile

lint-elixir:
  stage: check
  rules:
    - if: '$CI_PIPELINE_SOURCE == "trigger" && $CI_COMMIT_BRANCH == "main"'
      when: never
    - when: on_success
  before_script:
    - mix deps.get
  script:
    - export EXITVALUE=0
    - git fetch origin ${CI_DEFAULT_BRANCH}
    - TARGET_SHA1=$(git show-ref -s ${CI_DEFAULT_BRANCH})
    - echo "$TARGET_SHA1"
    - mix format --check-formatted --dry-run || export EXITVALUE=1
    - mix credo diff --from-git-merge-base $TARGET_SHA1 --strict -a || export EXITVALUE=1
    - mix sobelow --config || export EXITVALUE=1
    - exit $EXITVALUE
  artifacts:
    reports:
      codequality: codeclimate.json

lint-front:
  image: node:20
  stage: check
  rules:
    - if: '$CI_PIPELINE_SOURCE == "trigger" && $CI_COMMIT_BRANCH == "main"'
      when: never
    - when: on_success
  before_script:
    - export EXITVALUE=0
    - npm ci
  script:
    - npm run lint || export EXITVALUE=1
    - npx prettier -c . || export EXITVALUE=1
    - exit $EXITVALUE

build-frontend:
  stage: build-js
  image: node:20
  rules:
    - if: '$CI_PIPELINE_SOURCE == "trigger" && $CI_COMMIT_BRANCH == "main"'
      when: never
    - when: on_success
  before_script:
    - apt update
    - apt install -y --no-install-recommends python3 build-essential webp imagemagick gifsicle jpegoptim optipng pngquant
  script:
    - npm install --frozen-lockfile
    - npm run build
  artifacts:
    expire_in: 5 days
    paths:
      - priv/static
  needs:
    - job: lint-front
      optional: true

deps:
  stage: check
  rules:
    - if: '$CI_PIPELINE_SOURCE == "trigger" && $CI_COMMIT_BRANCH == "main"'
      when: never
    - when: on_success
  before_script:
    - mix deps.get
  script:
    - export EXITVALUE=0
    - mix hex.outdated || export EXITVALUE=1
    - npm outdated || export EXITVALUE=1
    - exit $EXITVALUE
  allow_failure: true
  needs:
    - job: install
      optional: true

exunit:
  stage: test
  rules:
    - if: '$CI_PIPELINE_SOURCE == "trigger" && $CI_COMMIT_BRANCH == "main"'
      when: never
    - when: on_success
  services:
    - name: postgis/postgis:16-3.4
      alias: postgres
  variables:
    MIX_ENV: test
  before_script:
    - apt update
    - apt install -y --no-install-recommends imagemagick
    - which identify || echo "identify command not found"
    - identify -version || echo "identify failed to run"
    - mix deps.get
    - mix compile
    - mix tz_world.update
    - mix ecto.create
    - mix ecto.migrate
  script:
    - mix coveralls
  artifacts:
    when: always
    reports:
      junit:
        - test-junit-report.xml
    expire_in: 30 days

vitest:
  stage: test
  rules:
    - if: '$CI_PIPELINE_SOURCE == "trigger" && $CI_COMMIT_BRANCH == "main"'
      when: never
    - when: on_success
  needs:
    - job: lint-front
      optional: true
  before_script:
    - npm install --frozen-lockfile
  script:
    - npm run coverage --reporter=default --reporter=junit --outputFile.junit=./junit.xml
  artifacts:
    when: always
    paths:
      - coverage
    reports:
      junit:
        - junit.xml
    expire_in: 30 days

# E2E tests for PRs using Docker (image built locally, not pushed)
e2e-docker-pr:
  stage: test
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
    MOBILIZON_E2E_IMAGE: "mobilizon-e2e:ci-${CI_COMMIT_SHORT_SHA}"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
  needs:
    - build-docker-pr
  tags:
    - "privileged"
  before_script:
    - apk add --no-cache nodejs npm
  script:
    - docker compose -f docker/e2e/docker-compose.yml up -d
    - npx wait-on http://localhost:4000 -t 120000 || (docker compose -f docker/e2e/docker-compose.yml logs && exit 1)
    - npx playwright install --with-deps chromium
    - npx playwright test --project chromium
  after_script:
    - docker compose -f docker/e2e/docker-compose.yml down -v
  artifacts:
    expire_in: 2 days
    when: always
    paths:
      - playwright-report/
      - test-results/

# E2E tests for main branch using Docker (image pulled from registry)
e2e-docker-main:
  stage: test
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
    MOBILIZON_E2E_IMAGE: "kaihuri/mobilizon:main"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "trigger" && $CI_COMMIT_BRANCH == "main"'
      when: never
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
  needs:
    - build-docker-main
  tags:
    - "privileged"
  before_script:
    - apk add --no-cache nodejs npm
    - mkdir -p ~/.docker
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"auth\":\"$CI_REGISTRY_AUTH\",\"email\":\"$CI_REGISTRY_EMAIL\"}}}" > ~/.docker/config.json
    - docker pull kaihuri/mobilizon:main
  script:
    - docker compose -f docker/e2e/docker-compose.yml up -d
    - npx wait-on http://localhost:4000 -t 120000 || (docker compose -f docker/e2e/docker-compose.yml logs && exit 1)
    - npx playwright install --with-deps chromium
    - npx playwright test --project chromium
  after_script:
    - docker compose -f docker/e2e/docker-compose.yml down -v
  artifacts:
    expire_in: 2 days
    when: always
    paths:
      - playwright-report/
      - test-results/

pages:
  stage: deploy
  script:
    - mv public public-mbz
    - mkdir public
    - mix deps.get
    - mix docs
    - mv doc public/backend
  #     #- npm run styleguide:build
  #     #- mv styleguide public/frontend
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  artifacts:
    expire_in: 1 hour
    paths:
      - public

.docker: &docker
  stage: build
  image: docker:24
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
    DOCKER_DRIVER: overlay2
    DOCKER_CLI_EXPERIMENTAL: enabled
  services:
    - docker:24-dind
  cache: {}
  before_script:
    # Install buildx
    - wget https://github.com/docker/buildx/releases/download/v0.11.2/buildx-v0.11.2.linux-amd64
    - mkdir -p ~/.docker/cli-plugins/
    - mv buildx-v0.11.2.linux-amd64 ~/.docker/cli-plugins/docker-buildx
    - chmod a+x ~/.docker/cli-plugins/docker-buildx
    # Create env
    - docker context create tls-environment
    - docker buildx create --use tls-environment
    # Install qemu/binfmt
    - docker pull tonistiigi/binfmt:latest
    - docker run --rm --privileged tonistiigi/binfmt:latest --install all
    # Install jq
    - apk --no-cache add jq
    # Login to DockerHub
    - mkdir -p ~/.docker
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"auth\":\"$CI_REGISTRY_AUTH\",\"email\":\"$CI_REGISTRY_EMAIL\"}}}" > ~/.docker/config.json
  tags:
    - "privileged"

# Build Docker image for PRs (without push) - used for E2E testing
build-docker-pr:
  <<: *docker
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
  script:
    - docker buildx build --load --platform linux/amd64 -t mobilizon-e2e:ci-${CI_COMMIT_SHORT_SHA} -f docker/production/Dockerfile .

build-docker-main:
  <<: *docker
  rules:
    - if: '$CI_PROJECT_NAMESPACE != "kaihuri"'
      when: never
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_PIPELINE_SOURCE == "trigger" && $CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
  script:
    - docker buildx build --push --platform linux/amd64 -t kaihuri/mobilizon:main -f docker/production/Dockerfile .

build-docker-tag:
  <<: *docker
  rules: &release-tag-rules
    - if: '$CI_PROJECT_NAMESPACE != "kaihuri"'
      when: never
    - if: $CI_COMMIT_TAG != null
      when: on_success
  timeout: 3 hours
  script:
    - >
      docker buildx build
      --push
      --platform linux/${ARCH}
      --provenance=false
      --build-arg="${ERL_FLAGS}"
      -t kaihuri/mobilizon:${CI_COMMIT_TAG}-${ARCH}
      -f docker/production/Dockerfile .
  parallel:
    matrix:
      - ARCH: ["amd64"]
        ERL_FLAGS: ["ERL_FLAGS="]
      - ARCH: ["arm64"]
        ERL_FLAGS: ["ERL_FLAGS=+JMsingle true"]

# Create manifest and push
docker-manifest-push:
  <<: *docker
  needs: ["build-docker-tag"]
  rules: &release-tag-rules
    - if: '$CI_PROJECT_NAMESPACE != "kaihuri"'
      when: never
    - if: $CI_COMMIT_TAG != null
      when: on_success
  script:
    - >
      docker manifest create kaihuri/mobilizon:${CI_COMMIT_TAG}
      --amend kaihuri/mobilizon:${CI_COMMIT_TAG}-amd64
      --amend kaihuri/mobilizon:${CI_COMMIT_TAG}-arm64
    - docker manifest push --purge kaihuri/mobilizon:${CI_COMMIT_TAG}

###
# Simply creating an alias to the tag doesn't work:
# « xxx is a manifest list »
# https://joonas.fi/2021/02/docker-multi-arch-image-tooling-buildx/
###
docker-latest:
  <<: *docker
  needs: ["docker-manifest-push"]
  rules: &release-tag-rules
    - if: '$CI_PROJECT_NAMESPACE != "kaihuri"'
      when: never
    - if: $CI_COMMIT_TAG != null && $CI_COMMIT_TAG !~ /alpha|beta|rc/
      when: on_success
  script:
    - echo docker manifest create kaihuri/mobilizon:latest $(docker manifest inspect kaihuri/mobilizon:$CI_COMMIT_TAG | jq '.manifests[] | .digest' | xargs -I {} echo kaihuri/mobilizon@{})
    - docker manifest create kaihuri/mobilizon:latest $(docker manifest inspect kaihuri/mobilizon:$CI_COMMIT_TAG | jq -r '.manifests[] | .digest' | xargs -I {} echo kaihuri/mobilizon@{})
    - docker manifest push --purge kaihuri/mobilizon:latest

# Packaging app for amd64
package-app:
  image: mobilizon/buildpack:1.16.1-erlang-26.2.2-${SYSTEM}
  stage: build
  variables: &release-variables
    MIX_ENV: "prod"
    DEBIAN_FRONTEND: noninteractive
    TZ: Etc/UTC
    APP_ASSET: "${CI_PROJECT_NAME}_${CI_COMMIT_REF_NAME}_${ARCH}.tar.gz"
  script: &release-script
    - mix local.hex --force
    - mix local.rebar --force
    - mix deps.clean --all # To avoid reusing native deps, such as lexbor being already built against another environment
    - mix deps.get --only-prod
    - mix compile
    - mix phx.digest.clean --all && mix phx.digest
    - mix release --path release/mobilizon
    - cd release/mobilizon && ln -s lib/mobilizon-*/priv priv && cd ../../
    - du -sh release/
    - 'echo "Artifact: ${APP_ASSET}"'
    - tar czf ${APP_ASSET} -C release mobilizon
    - du -sh ${APP_ASSET}
  only:
    - tags@kaihuri/mobilizon
  artifacts:
    expire_in: 2 days
    paths:
      - ${APP_ASSET}
  parallel:
    matrix:
      - SYSTEM:
          [
            "debian-bookworm",
            "debian-bullseye",
            "debian-buster",
            "ubuntu-jammy",
            "ubuntu-focal",
            "fedora-38",
            "fedora-39",
          ]

package-app-dev:
  stage: build
  variables: *release-variables
  script: *release-script
  except:
    - tags@kaihuri/mobilizon
  artifacts:
    expire_in: 2 days
    paths:
      - ${APP_ASSET}

# Packaging app for multi-arch
package-multi-arch-release:
  stage: build
  image: docker:24
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
    DOCKER_DRIVER: overlay2
    APP_ASSET: "${CI_PROJECT_NAME}_${CI_COMMIT_REF_NAME}_${ARCH}.tar.gz"
    OS: debian-buster
  services:
    - docker:24-dind
  cache: {}
  before_script:
    # Install buildx
    - wget https://github.com/docker/buildx/releases/download/v0.11.2/buildx-v0.11.2.linux-amd64
    - mkdir -p ~/.docker/cli-plugins/
    - mv buildx-v0.11.2.linux-amd64 ~/.docker/cli-plugins/docker-buildx
    - chmod a+x ~/.docker/cli-plugins/docker-buildx
    # Create env
    - docker context create tls-environment
    - docker buildx create --use tls-environment
    # Install qemu/binfmt
    - docker pull tonistiigi/binfmt:latest
    - docker run --rm --privileged tonistiigi/binfmt:latest --install all
  script:
    - docker buildx build --platform linux/${ARCH} --output type=local,dest=releases --build-arg="ERL_FLAGS=+JMsingle true" --build-arg APP_ASSET=${APP_ASSET} -f docker/multiarch/Dockerfile .
    - ls -alh releases/mobilizon/
    - du -sh releases/mobilizon/${APP_ASSET}
    - mv releases/mobilizon/${APP_ASSET} .
  tags:
    - "privileged"
  artifacts:
    expire_in: 2 days
    paths:
      - ${APP_ASSET}
      - erl_crash.dump # if there's a memory issue
  parallel:
    matrix:
      - ARCH: ["arm64"]
        ## Currently not used as the hexpm base images do not have support for other architectures than amd64
        # SYSTEM:
        #   [
        #     "debian-bookworm",
        #     "debian-bullseye",
        #     "ubuntu-jammy",
        #     "ubuntu-focal",
        #     "ubuntu-bionic",
        #     "alpine-3.17.5",
        #     "alpine-3.18.4",
        #     "fedora-38",
        #     "fedora-39",
        #   ]
  rules:
    - if: '$CI_COMMIT_TAG != null || $CI_PIPELINE_SOURCE == "schedule" || $CI_PIPELINE_TRIGGERED == "true"'
  timeout: 3h
  allow_failure: true

# Release
release-upload:
  stage: upload
  image: framasoft/upload-packages:latest
  variables:
    APP_ASSET: "${CI_PROJECT_NAME}_${CI_COMMIT_REF_NAME}_${ARCH}.tar.gz"
  rules:
    - if: '$CI_PROJECT_NAMESPACE != "kaihuri"'
      when: never
  script:
    - eval `ssh-agent -s`
    - ssh-add <(echo "${DEPLOYEMENT_KEY}" | base64 --decode -i)
    - echo "put -r ${APP_ASSET}" | sftp -o "VerifyHostKeyDNS yes" ${DEPLOYEMENT_USER}@${DEPLOYEMENT_HOST}:public/
  artifacts:
    expire_in: 1 day
    when: on_success
    paths:
      - mobilizon_*.tar.gz
  parallel:
    matrix:
      - ARCH: ["amd64", "arm", "arm64"]
  allow_failure: true

release-create:
  stage: deploy
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  rules:
    - if: '$CI_PROJECT_NAMESPACE != "kaihuri"'
      when: never
  variables:
    APP_ASSET_AMD64: "${CI_PROJECT_NAME}_${CI_COMMIT_REF_NAME}_amd64.tar.gz"
    APP_ASSET_ARM: "${CI_PROJECT_NAME}_${CI_COMMIT_REF_NAME}_arm.tar.gz"
    APP_ASSET_ARM64: "${CI_PROJECT_NAME}_${CI_COMMIT_REF_NAME}_arm64.tar.gz"
  before_script:
    - apk --no-cache add gawk sed grep
  script: |
    CHANGELOG=$(awk -v version="$APP_VERSION" '/^## / { printit = $2 == version }; printit' docs/CHANGELOG.md | grep -v "## $APP_VERSION" | sed '1{/^$/d}')
    ENDPOINT="https://packages.joinmobilizon.org"

    release-cli create  --name "$CI_COMMIT_TAG" \
                        --description "$CHANGELOG" \
                        --tag-name "$CI_COMMIT_TAG" \
                        --assets-link "{\"name\":\"${APP_ASSET_AMD64}\",\"url\":\"${ENDPOINT}/${CI_COMMIT_REF_NAME}/${APP_ASSET_AMD64}\"}" \
                        --assets-link "{\"name\":\"${APP_ASSET_ARM}\",\"url\":\"${ENDPOINT}/${CI_COMMIT_REF_NAME}/${APP_ASSET_ARM}\"}" \
                        --assets-link "{\"name\":\"${APP_ASSET_ARM64}\",\"url\":\"${ENDPOINT}/${CI_COMMIT_REF_NAME}/${APP_ASSET_ARM64}\"}"
